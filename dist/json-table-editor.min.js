!function(t,e){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=t.document?e(t,!0):function(t){if(!t.document)throw new Error("JSONTableEditor requires a window with a document");return e(t)}:e(t)}("undefined"!=typeof window?window:this,function(r,t){"use strict";var o={formatOptions:[{type:"button",name:"bold",innerHTML:"Bold"},{type:"button",name:"italic",innerHTML:"Italic"},{type:"radio",name:"align",options:["left","center","right"]}],gridColumns:10,gridRows:10,selectorWrongMsg:"Can't find html element with given selector.",formatOptionsId:"jt-format-options",colBtnId:"jt-col-btn",rowBtnId:"jt-row-btn",tableMainClass:"js-main-table"};function e(t,e,n,o){return this.init(t,e,n,o)}function n(t,e){return this.init(t,e)}function i(t,e){return this.init(t,e)}function a(t){return this.init(t)}function s(t,e){return this.init(t,e)}function l(t,e,n){return this.init(t,n,e)}return e.prototype={init:function(t,e,n,o){return this.root=t,this.callback=e,this.rows=n,this.columns=o,this.render()},setCurrentCell:function(t){this.currentCell=t},markCells:function(){[].forEach.call(this.cellsElements,function(t){var e=parseInt(t.dataset.column,10),n=parseInt(t.dataset.row,10);!0===(this.currentCell&&n<=this.currentCell.row&&e<=this.currentCell.column)?t.classList.add("active"):t.classList.remove("active")}.bind(this))},generateCells:function(){var t=-1;this.cells=[];for(var e=0;e<this.rows*this.columns;e++){var n=e%this.columns;0===n&&t++,this.cells.push({column:n,row:t,active:!1})}},html:function(){var t='<div class="jt-grid clearfix" style="width:'+(16*this.columns+2)+"px;height:"+(16*this.rows+2)+'px;">';return t+=this.cellsHTML(),t+="</div>"},cellsHTML:function(){var e="";return this.generateCells(),this.cells.map(function(t){e+='<a href="#" class="jt-grid--cell'+(!0===t.active?" active":"")+'" data-row="'+t.row+'" data-column="'+t.column+'">',e+="</a>"}),e},render:function(){this.root.innerHTML=this.html(),this.cellsElements=this.root.querySelectorAll("a"),this.bindEvents()},bindEvents:function(){[].forEach.call(this.cellsElements,function(t){this.onMouseEnter(t),this.onClick(t)}.bind(this))},onMouseEnter:function(t){var e,n=this;t.addEventListener("mouseenter",function(){clearTimeout(e);var t=this.dataset;e=setTimeout(function(){n.currentCell={column:parseInt(t.column,10),row:parseInt(t.row,10)},n.markCells()},50)})},onClick:function(t){var e=this;t.addEventListener("click",function(t){t.preventDefault(),e.callback(this.dataset.row,this.dataset.column)})}},n.prototype={init:function(t,e){this.view=t,this.model=e,this.bindArrowKeys()},bindArrowKeys:function(){var e=this;this.view.container.addEventListener("keydown",function(t){e.model.currentCell&&"TD"===t.target.tagName&&(37===t.keyCode&&l.cursorAtEndOrStart(t.target).atStart?e.moveArrowLeftRight(-1):38===t.keyCode&&l.cursorAtEndOrStart(t.target).atStart?e.moveArrowUpDown(-1):39===t.keyCode&&l.cursorAtEndOrStart(t.target).atEnd?e.moveArrowLeftRight(1):40===t.keyCode&&l.cursorAtEndOrStart(t.target).atEnd&&e.moveArrowUpDown(1))})},moveArrowUpDown:function(t){var e=Object.assign({},this.model.currentCell);e.row=(Number(e.row)+t+this.model.meta.rows)%this.model.meta.rows,(0===e.row&&1===t||e.row===this.model.meta.rows-1&&-1===t)&&(e.col=(Number(e.col)+t+this.model.meta.columns)%this.model.meta.columns),this.view.focusCurrentCell(e)},moveArrowLeftRight:function(t){var e=Object.assign({},this.model.currentCell);e.col=(Number(e.col)+t+this.model.meta.columns)%this.model.meta.columns,(0===e.col&&1===t||e.col===this.model.meta.columns-1&&-1===t)&&(e.row=(Number(e.row)+t+this.model.meta.rows)%this.model.meta.rows),this.view.focusCurrentCell(e)}},i.prototype={init:function(t,e){this.table=document.createElement("table"),this.table.setAttribute("class",o.tableMainClass),this.cellTag="td",this.container=t,this.formatOptions=e,this.formatOptionsId=o.formatOptionsId,this.colBtnId=o.colBtnId,this.rowBtnId=o.rowBtnId},insert:function(t){var e=this.container;e.firstChild?e.replaceChild(this.table,e.childNodes[0]):e.append(this.table),e.insertAdjacentHTML("afterbegin",this.formatOptionsContainer()),this.updateFormatOptions(),e.insertAdjacentHTML("beforeend",this.utilButtons())},update:function(t){return this.table.innerHTML=this.html(t.meta.rows,t.meta.columns,t.data),t.currentCell&&this.focusCurrentCell(t.currentCell),!0},updateFormatOptions:function(t){l.qs("#"+this.formatOptionsId,this.container).innerHTML=this.formatButtons(t)+this.formatRadioButtons(t)},formatRadioButtons:function(t){for(var e="",n=this.formatOptions.filter(function(t){return"radio"===t.type}),o=0;o<n.length;o++){e+="<span>";for(var i=0;i<n[o].options.length;i++){var a=n[o].options[i];e+='<button data-code="5" data-formatkey="'+n[o].name+'" data-radioval="'+a+'" title="'+a+" "+n[o].name+'" class="'+(t&&t[n[o].name]===a?" active":"")+'"'+(t?" ":" disabled")+">"+a+"</button>"}e+="</span>"}return e},formatButtons:function(t){for(var e="",n=this.formatOptions.filter(function(t){return"button"===t.type}),o=0;o<n.length;o++)e+='<button data-code="5" data-formatkey="'+n[o].name+'" class="'+(t&&t[n[o].name]?" active":"")+'"'+(t?" ":" disabled")+">"+n[o].innerHTML+"</button>";return e},focusCurrentCell:function(t){t=t||{};var e="[data-row='"+String(t.row)+"'][data-col='"+String(t.col)+"']",n=l.qs(e,this.container);n&&(n.focus(),setTimeout(function(){l.setEndOfContenteditable(n)},0))},formatOptionsContainer:function(){var t='<div class="jt-format-options" id="'+this.formatOptionsId+'">';return t+="</div>"},utilButtons:function(){return'<div class="jt-row-btn" id="'+this.rowBtnId+'"><button data-code="3" title="add a row">+</button><button data-code="4" title="remove a row">-</button></div><div class="jt-col-btn" id="'+this.colBtnId+'"><button data-code="1" title="add a column">+</button><button data-code="2" title="remove a column">-</button></div>'},html:function(t,e,n){for(var o="",i=0;i<t;i++){o+="<tr>";for(var a=0;a<e;a++)o+=this.cell(i,a,n[i][a]);o+="</tr>"}return o},cell:function(t,e,n){var o="";return o+="<"+this.cellTag+" contenteditable",o+=" data-row='"+t+"'",o+=" data-col='"+e+"'",o+=" class='"+this.cellClassList(n.format)+"'",o+=">"+n.content+"</"+this.cellTag+">"},cellClassList:function(t){var e="";if(t&&"object"==typeof t)for(var n in t)t.hasOwnProperty(n)&&t[n]&&("true"!==t[n]&&!0!==t[n]?e+="jt-cell-"+t[n].replace(/ /g,"-")+" ":e+="jt-cell-"+n.replace(/ /g,"-")+" ");return e}},a.prototype={init:function(t){this.tableData=t||{meta:{},data:[]},this.meta=this.tableData.meta,this.data=this.tableData.data,this.meta.rows=null,this.meta.columns=null,this.currentCell=null,this.data_changed_event=new r.Event("dataChanged")},isValidData:function(){var t=this.data;return t&&"object"==typeof t&&t.constructor===Array&&t.length&&t[0].length&&t[0][0].hasOwnProperty("content")},setRowCol:function(){this.setRowColUtil(this.data.length,this.data[0].length)},setDefaultData:function(t,e){this.setRowColUtil(t,e),this.updateDataAddRemoveExtraRowColumn()},setCurrentCell:function(t){this.currentCell=t},updateContent:function(t){var e=Number(t.target.dataset.row),n=Number(t.target.dataset.col);this.data.length>e&&this.data[0].length>n&&(this.data[e][n].content=t.target.innerHTML)},updateContentOfCurrentCell:function(t){if(this.currentCell){var e=Number(this.currentCell.row),n=Number(this.currentCell.col),o="[data-row='"+String(e)+"'][data-col='"+String(n)+"']",i=l.qs(o,t);i&&this.data.length>e&&this.data[0].length>n&&(this.data[e][n].content=i.innerHTML)}},addARow:function(){this.meta.rows+=1,this.updateDataAddRemoveExtraRowColumn()},removeARow:function(){1<this.meta.rows&&(this.meta.rows-=1,this.updateDataAddRemoveExtraRowColumn())},addAColumn:function(){this.meta.columns+=1,this.updateDataAddRemoveExtraRowColumn()},removeAColumn:function(){1<this.meta.columns&&(this.meta.columns-=1,this.updateDataAddRemoveExtraRowColumn())},updateFormatOfCurrentCell:function(t,e){var n=this.currentCell;if(n&&e.target.dataset.radioval)this.data[n.row][n.col].format[t]=e.target.dataset.radioval;else if(n){var o=this.data[n.row][n.col].format;this.data[n.row][n.col].format[t]=!o[t]}},updateDataAddRemoveExtraRowColumn:function(){for(var t=r.Number(this.meta.rows),e=r.Number(this.meta.columns);this.data.length!==t;)if(this.data.length>t)this.data.pop();else{if(!(this.data.length<t))break;this.data.push([])}for(var n=0;n<t;n++)for(;this.data[n].length!==e;)if(this.data[n].length>e)this.data[n].pop();else{if(!(this.data[n].length<e))break;this.data[n].push(this.defaultCellData())}},setRowColUtil:function(t,e){this.meta.rows=Number(t),this.meta.columns=Number(e)},defaultCellData:function(){var t={content:"",format:{}};return t}},s.prototype={init:function(t,e){this.view=t,this.model=e},bindEvents:function(){var e=this;this.bindEventOnCell("focus",function(t){e.handleCellFocus(t)}),this.bindEventOnCell("blur",function(t){e.handleCellBlur(t)}),this.bindEventOnFormatingOptions()},bindEventOnCell:function(t,e){l.delegate(this.view.table,this.view.cellTag,t,e)},bindEventOnFormatingOptions:function(){for(var e=this,t=[this.view.formatOptionsId,this.view.rowBtnId,this.view.colBtnId],n=0;n<t.length;n++)l.delegate(l.qs("#"+t[n],this.view.container),"button","click",function(t){e.handleBtnClick(t)}),l.delegate(l.qs("#"+t[n],this.view.container),"button","mousedown",function(t){t.preventDefault()})},handleCellFocus:function(t){var e=this;this.model.setCurrentCell(t.target.dataset),setTimeout(function(){e.view.updateFormatOptions(e.model.data[t.target.dataset.row][t.target.dataset.col].format)},0)},handleCellBlur:function(t){var e=this;this.model.updateContent(t),this.view.container.dispatchEvent(this.model.data_changed_event),setTimeout(function(){e.view.updateFormatOptions()},0)},handleBtnClick:function(t){var e=t.target.dataset,n=r.Number(e.code);1===n?this.model.addAColumn():2===n?this.model.removeAColumn():3===n?this.model.addARow():4===n?this.model.removeARow():5===n&&this.model.updateFormatOfCurrentCell(e.formatkey,t),this.model.updateContentOfCurrentCell(this.view.container),this.view.container.dispatchEvent(this.model.data_changed_event),this.view.update(this.model)}},l.prototype={init:function(t,e,n){if(n&&"object"==typeof n||(n={}),this.gridRows=n.gridRows||o.gridRows,this.gridColumns=n.gridColumns||o.gridColumns,this.formatOptions=n.formatOptions||o.formatOptions,this.container=l.qs(t),!this.container)throw o.selectorWrongMsg;this.model=new a(e),this.view=new i(this.container,this.formatOptions),this.controller=new s(this.view,this.model),this.setupTable()},setupTable:function(){this.model.isValidData()?(this.model.setRowCol(),this.initTable()):this.grid=new e(this.container,function(t,e){this.model.setDefaultData(Number(t)+1,Number(e)+1),this.initTable()}.bind(this),this.gridRows,this.gridColumns)},initTable:function(){this.view.insert(this.model),this.view.update(this.model),this.controller.bindEvents(),this.keyboardHandler=new n(this.view,this.model)}},l.qs=function(t,e){return(e||document).querySelector(t)},l.qsa=function(t,e){return(e||document).querySelectorAll(t)},l.on=function(t,e,n,o){t.addEventListener(e,n,!!o)},l.delegate=function(o,i,t,a){l.on(o,t,function(t){var e=t.target,n=l.qsa(i,o);0<=Array.prototype.indexOf.call(n,e)&&a.call(e,t)},"blur"===t||"focus"===t)},l.setEndOfContenteditable=function(t){var e,n;document.createRange?((e=document.createRange()).selectNodeContents(t),e.collapse(!1),(n=r.getSelection()).removeAllRanges(),n.addRange(e)):document.selection&&((e=document.body.createTextRange()).moveToElementText(t),e.collapse(!1),e.select())},l.orEmpty=function(t){return t||""},l.cursorAtEndOrStart=function(t){var e,n,o=!1,i=!1;if(r.getSelection){var a=r.getSelection();a.rangeCount&&((n=(e=a.getRangeAt(0)).cloneRange()).selectNodeContents(t),n.setEnd(e.startContainer,e.startOffset),o=""===n.toString(),n.selectNodeContents(t),n.setStart(e.endContainer,e.endOffset),i=""===n.toString())}return{atStart:o,atEnd:i}},"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(t),o=1;o<arguments.length;o++){var i=arguments[o];if(null!=i)for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(n[a]=i[a])}return n},writable:!0,configurable:!0}),r.JSONTableEditor=l});